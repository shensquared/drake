classdef MyPendulumCL < PolynomialSystem
% Defines the dynamics for the Pendulum.
  
  properties
    m = 1;   % kg
    l = .5;  % m
    b = 0.1; % kg m^2 /s
    lc = .5; % m
    I = .25; %m*l^2; % kg*m^2
    g = 9.81; % m/s^2
    
    xG;
    uG;
  end
  
  methods
    function obj = MyPendulumCL(b)
      % Construct a new PendulumPlant
      obj = obj@PolynomialSystem(4,0,1,2,false,true,false);
      obj = setStateFrame(obj,CoordinateFrame('MyPendulumState',4,'x',{'theta','thetadot','thetahat','thetahatdot'}));

      % obj = obj@PolynomialSystem(6,0,2,2,false,true,false);
      if nargin>0 && ~isempty(b) % accept damping as optional input
        obj.b = b;
      end
      % obj = setStateFrame(obj,PendulumState);
      obj = setOutputFrame(obj,PendulumState);
      % obj = setStateFrame(obj,CoordinateFrame('MyPendulumState',6,'x',{'sin','cos','thetadot','sinhat','coshat','thetahatdot'}));
      % obj = setOutputFrame(obj,MyPendulumState);
    end

    function xdot = dynamicsRHS(~,~,x,u)
      p= MyPendulumCL;
      q=x(1);
      qd=x(2);
      qdd = (- p.m*p.g*p.lc*sin(q) - p.b*qd)/p.I;
      qhat=x(3);
      qdhat=x(4);      
      qddhat = (- p.m*p.g*p.lc*sin(qhat) - p.b*qdhat)/p.I;
      xdotopenloop=[qd;qdd;qdhat;qddhat];
      [K,L]=readPartition(x);
      xdot=xdotopenloop+[0;K;0;K]+[0;0;L];
      % xdot=xdotopenloop+[0;K;0;K]+[0;0;L];
      % xdot=[fx+K;fxhat-L];
      % fx = [x(2,:).*x(3,:); -x(1,:).*x(3,:); (-p.b.*x(3,:) - p.m*p.g*p.l.*x(1,:)-3)/(p.m*p.l.^2)];
      % fxhat=[x(5,:).*x(6,:); -x(4,:).*x(6,:); (-p.b.*x(6,:) - p.m*p.g*p.l.*x(4,:)-3)/(p.m*p.l.^2)];
      % df = [zeros(3,1),[0, x(3)/2, x(2)/2;-x(3)/2, 0, -x(1)/2; -p.g/p.l, 0, -p.b/(p.m*p.l.^2)]];
    end

    function y=output(~,~,x,~)
      y=x(1:2);
    end
  end
end



function [K,L]=readPartition(state)
n=3;
x=msspoly('x',n);
h=msspoly('h',n);
observed=[x(1);x(2)];
load('partitionDOF.mat')
s1=sin(state(1));
s2=cos(state(1))+1;
s3=state(2);
sh1=sin(state(3));
sh2=cos(state(3))+1;
sh3=state(4);
K=dmsubs(K',h,[sh1;sh2;sh3]);
L1_old=dmsubs(L1,[observed;h],[s1;s2;sh1;sh2;sh3]);
L2_old=dmsubs(L2,[observed;h],[s1;s2;sh1;sh2;sh3]);
L_old=L1_old-L2_old;
L=[rem(sqrt(L_old(1)^2+L_old(2)^2)*sign(L_old(1)*cos(state(3))),2*pi);L_old(3)];
end



function [K,L]=inlinePartition(state)
x1=sin(state(1));
x2=cos(state(1))+1;
x3=state(2);
h1=sin(state(3));
h2=cos(state(3))+1;
h3=state(4);

K=[  (53.743)*h1+(-1.0628e-15)*h1^2+(8.5192)*h1^3+(-1.1434e-15)*h1^4+(-8.3454e-16)*h2+(1.2386e-16)*h2^2+(-1.0686e-15)*h2^3+(-1.424e-16)*h2^4+(0.01271)*h2*h1+(-1.6685e-15)*h2*h1^2+(0.060352)*h2*h1^3+(8.6151)*h2^2*h1+(-1.7444e-15)*h2^2*h1^2+(0.12377)*h2^3*h1+(-19.811)*h3+(7.4149e-17)*h3^2+(-4.6565)*h3^3+(6.2081e-16)*h3*h1+(-4.9212)*h3*h1^2+(-1.0663e-15)*h3*h1^3+(7.8715)*h3^2*h1+(-1.0809e-15)*h3^2*h1^2+(5.499e-16)*h3^3*h1+(0.005634)*h3*h2+(-4.9252)*h3*h2^2+(-0.044273)*h3*h2^3+(8.776e-17)*h3^2*h2+(1.6557e-16)*h3^2*h2^2+(0.012654)*h3^3*h2+(5.036e-16)*h3*h2*h1+(-0.030633)*h3*h2*h1^2+(-9.3904e-16)*h3*h2^2*h1+(-0.047027)*h3^2*h2*h1  ];
L1=[                                                                                 (-10.663)*h1+(2.2293e-16)*h1^2+(-4.2096)*h1^3+(-1.8427e-16)*h1^4+(10.707)*x1+(1.7261e-16)*x1^2+(2.9334)*x1^3+(1.8477e-16)*x1^4+(-4.8778e-16)*x1*h1+(4.2012)*x1*h1^2+(-3.4006e-16)*x1*h1^3+(-2.9345)*x1^2*h1+(1.6236e-16)*x1^2*h1^2+(1.5023e-16)*x1^3*h1+(7.4754e-17)*h2+(1.614e-16)*h2^2+(1.2326e-16)*h2^3+(5.42e-16)*h2^4+(-0.68716)*h2*h1+(-2.5954e-16)*h2*h1^2+(-1.9607)*h2*h1^3+(-2.0895)*h2^2*h1+(-6.3017e-17)*h2^2*h1^2+(-1.4044)*h2^3*h1+(0.37234)*h2*x1+(2.6251e-16)*h2*x1^2+(0.69184)*h2*x1^3+(2.0854)*h2^2*x1+(4.5136e-16)*h2^2*x1^2+(1.4057)*h2^3*x1+(2.3934e-16)*h2*x1*h1+(1.961)*h2*x1*h1^2+(-0.75188)*h2*x1^2*h1+(-8.6121e-17)*h2^2*x1*h1+(-6.8125e-17)*x2+(2.088e-16)*x2^2+(-5.6115e-16)*x2^3+(8.4535e-16)*x2^4+(-0.60058)*x2*h1+(2.0958e-17)*x2*h1^2+(-0.88764)*x2*h1^3+(-3.1504)*x2^2*h1+(5.69e-16)*x2^2*h1^2+(-2.6534)*x2^3*h1+(0.90801)*x2*x1+(-4.6397e-16)*x2*x1^2+(1.1852)*x2*x1^3+(3.1766)*x2^2*x1+(9.0924e-16)*x2^2*x1^2+(2.6759)*x2^3*x1+(2.2053e-16)*x2*x1*h1+(0.88747)*x2*x1*h1^2+(-1.1274)*x2*x1^2*h1+(-1.6359e-15)*x2^2*x1*h1+(-3.6982e-16)*x2*h2+(-8.3008e-16)*x2*h2^2+(-7.2748e-16)*x2*h2^3+(1.268e-15)*x2^2*h2+(-7.1516e-16)*x2^2*h2^2+(5.4812e-17)*x2^3*h2+(0.00048835)*x2*h2*h1+(1.7757e-16)*x2*h2*h1^2+(-0.4393)*x2*h2^2*h1+(-0.71797)*x2^2*h2*h1+(-0.030373)*x2*h2*x1+(-3.4121e-16)*x2*h2*x1^2+(0.43821)*x2*h2^2*x1+(0.6944)*x2^2*h2*x1+(-5.0889e-18)*x2*h2*x1*h1+(-0.020825)*h3+(-6.0065e-18)*h3^2+(0.0015959)*h3^3+(1.0011e-18)*h3^4+(1.6118e-16)*h3*h1+(0.29441)*h3*h1^2+(8.3468e-17)*h3*h1^3+(-3.2534)*h3^2*h1+(-2.5813e-16)*h3^2*h1^2+(4.7278e-16)*h3^3*h1+(-1.1238e-16)*h3*x1+(0.020112)*h3*x1^2+(-4.4124e-16)*h3*x1^3+(3.3894)*h3^2*x1+(4.5637e-17)*h3^2*x1^2+(-4.7242e-16)*h3^3*x1+(-0.71203)*h3*x1*h1+(-9.9198e-17)*h3*x1*h1^2+(4.6637e-16)*h3*x1^2*h1+(2.1352e-16)*h3^2*x1*h1+(0.66605)*h3*h2+(0.15191)*h3*h2^2+(0.044943)*h3*h2^3+(-3.9293e-17)*h3^2*h2+(-1.9585e-16)*h3^2*h2^2+(9.6546)*h3^3*h2+(1.0406e-16)*h3*h2*h1+(0.044139)*h3*h2*h1^2+(8.5301e-17)*h3*h2^2*h1+(-0.93829)*h3^2*h2*h1+(-1.5596e-16)*h3*h2*x1+(0.27795)*h3*h2*x1^2+(4.1331e-17)*h3*h2^2*x1+(0.9082)*h3^2*h2*x1+(-0.033491)*h3*h2*x1*h1+(-0.66725)*h3*x2+(0.15749)*h3*x2^2+(-0.27502)*h3*x2^3+(3.9551e-17)*h3^2*x2+(3.5437e-16)*h3^2*x2^2+(-9.655)*h3^3*x2+(-9.7608e-17)*h3*x2*h1+(-0.021624)*h3*x2*h1^2+(2.6862e-17)*h3*x2^2*h1+(-0.50821)*h3^2*x2*h1+(1.5215e-16)*h3*x2*x1+(-0.2888)*h3*x2*x1^2+(-1.7967e-15)*h3*x2^2*x1+(0.5389)*h3^2*x2*x1+(0.02225)*h3*x2*x1*h1+(-0.37926)*h3*x2*h2+(-0.059614)*h3*x2*h2^2+(0.29003)*h3*x2^2*h2+(-1.591e-16)*h3^2*x2*h2+(4.909e-16)*h3*x2*h2*h1+(1.1722e-15)*h3*x2*h2*x1  ];
L2=[  (1.9506e-16)*h1+(-8.8818e-16)*h1^2+(1.5983e-16)*h1^3+(6.9979e-33)*h1^4+(-1.1059e-16)*x1+(-1.2198e-32)*x1^2+(-1.0802e-16)*x1^3+(-4.1151e-33)*x1^4+(0.00034233)*x1*h1+(-1.5953e-16)*x1*h1^2+(1.2913e-32)*x1*h1^3+(1.3931e-16)*x1^2*h1+(-6.1651e-33)*x1^2*h1^2+(0.048246)*x1^3*h1+(-3.766)*h2+(-1.2295)*h2^2+(-4.3161)*h2^3+(-4.1094)*h2^4+(2.1619e-17)*h2*h1+(9.8567e-33)*h2*h1^2+(7.4452e-17)*h2*h1^3+(9.2399e-17)*h2^2*h1+(2.3944e-33)*h2^2*h1^2+(8.1539e-18)*h2^3*h1+(-1.0474e-16)*h2*x1+(-2.8837)*h2*x1^2+(8.6275e-16)*h2*x1^3+(-1.6177e-16)*h2^2*x1+(-1.1809)*h2^2*x1^2+(-5.0348e-16)*h2^3*x1+(-9.088e-33)*h2*x1*h1+(-7.4462e-17)*h2*x1*h1^2+(2.5441e-17)*h2*x1^2*h1+(3.2701e-33)*h2^2*x1*h1+(3.76)*x2+(0.89847)*x2^2+(3.0819)*x2^3+(2.5692)*x2^4+(4.5239e-18)*x2*h1+(-7.9582e-34)*x2*h1^2+(3.3705e-17)*x2*h1^3+(7.5219e-17)*x2^2*h1+(-2.1606e-32)*x2^2*h1^2+(1.0891e-16)*x2^3*h1+(5.0343e-17)*x2*x1+(2.8837)*x2*x1^2+(-9.3593e-16)*x2*x1^3+(-1.1493e-15)*x2^2*x1+(1.1209)*x2^2*x1^2+(1.8203e-15)*x2^3*x1+(-0.0079455)*x2*x1*h1+(-3.3698e-17)*x2*x1*h1^2+(6.635e-17)*x2*x1^2*h1+(0.021341)*x2^2*x1*h1+(0.33116)*x2*h2+(4.3897)*x2*h2^2+(3.3697)*x2*h2^3+(-3.1607)*x2^2*h2+(-0.37919)*x2^2*h2^2+(-1.4471)*x2^3*h2+(-1.8543e-20)*x2*h2*h1+(-6.7426e-33)*x2*h2*h1^2+(1.6681e-17)*x2*h2^2*h1+(-1.612e-18)*x2^2*h2*h1+(1.1137e-15)*x2*h2*x1+(0.060029)*x2*h2*x1^2+(2.6966e-15)*x2*h2^2*x1+(-4.2134e-15)*x2^2*h2*x1+(0.0010015)*x2*h2*x1*h1+(-3.1156e-17)*h3+(0.00076376)*h3^2+(2.1821e-18)*h3^3+(-6.3074e-05)*h3^4+(0.99871)*h3*h1+(-1.1175e-17)*h3*h1^2+(-3.1684e-33)*h3*h1^3+(1.0886e-16)*h3^2*h1+(9.8024e-33)*h3^2*h1^2+(0.00010653)*h3^3*h1+(-1.0004)*h3*x1+(-1.2693e-17)*h3*x1^2+(-0.016781)*h3*x1^3+(-1.1213e-16)*h3^2*x1+(4.5949e-05)*h3^2*x1^2+(1.7938e-32)*h3^3*x1+(9.7833e-18)*h3*x1*h1+(3.7667e-33)*h3*x1*h1^2+(-7.7606e-05)*h3*x1^2*h1+(2.1652e-33)*h3^2*x1*h1+(-3.819e-17)*h3*h2+(3.482e-16)*h3*h2^2+(5.6278e-16)*h3*h2^3+(-2.8802)*h3^2*h2+(-1.7031)*h3^2*h2^2+(-6.4846e-16)*h3^3*h2+(0.00050258)*h3*h2*h1+(-1.676e-18)*h3*h2*h1^2+(6.8848e-05)*h3*h2^2*h1+(5.033e-17)*h3^2*h2*h1+(0.012816)*h3*h2*x1+(8.7121e-16)*h3*h2*x1^2+(0.021231)*h3*h2^2*x1+(9.7944e-17)*h3^2*h2*x1+(1.2717e-18)*h3*h2*x1*h1+(4.9001e-17)*h3*x2+(-1.8713e-16)*h3*x2^2+(6.3381e-16)*h3*x2^3+(2.8799)*h3^2*x2+(0.46974)*h3^2*x2^2+(6.3976e-16)*h3^3*x2+(2.9811e-33)*h3*x2*h1+(8.2111e-19)*h3*x2*h1^2+(2.6316e-06)*h3*x2^2*h1+(2.0824e-17)*h3^2*x2*h1+(-0.0099946)*h3*x2*x1+(-8.8181e-16)*h3*x2*x1^2+(-0.0064367)*h3*x2^2*x1+(-1.4901e-16)*h3^2*x2*x1+(-9.9468e-18)*h3*x2*x1*h1+(-1.5719e-16)*h3*x2*h2+(9.9108e-17)*h3*x2*h2^2+(-1.2533e-15)*h3*x2^2*h2+(1.2333)*h3^2*x2*h2+(-1.864e-32)*h3*x2*h2*h1+(-0.022769)*h3*x2*h2*x1  ];
L3=[                                                                           (27.533)*h1+(-2.2962e-16)*h1^2+(4.3275)*h1^3+(1.8831e-16)*h1^4+(-27.577)*x1+(1.3904e-16)*x1^2+(-3.1996)*x1^3+(-3.5223e-16)*x1^4+(2.2871e-16)*x1*h1+(-4.3127)*x1*h1^2+(3.4908e-16)*x1*h1^3+(3.2066)*x1^2*h1+(-1.6667e-16)*x1^2*h1^2+(-2.1116e-16)*x1^3*h1+(3.8986e-17)*h2+(-1.1112e-16)*h2^2+(6.3912e-17)*h2^3+(-3.7441e-16)*h2^4+(0.7054)*h2*h1+(2.652e-16)*h2*h1^2+(2.0128)*h2*h1^3+(2.1513)*h2^2*h1+(6.3406e-17)*h2^2*h1^2+(1.4417)*h2^3*h1+(0.25914)*h2*x1+(-3.5515e-17)*h2*x1^2+(-0.57397)*h2*x1^3+(-2.1408)*h2^2*x1+(-4.1101e-16)*h2^2*x1^2+(-1.443)*h2^3*x1+(-2.4569e-16)*h2*x1*h1+(-2.013)*h2*x1*h1^2+(0.77183)*h2*x1^2*h1+(8.8406e-17)*h2^2*x1*h1+(-3.1841e-17)*x2+(6.6622e-16)*x2^2+(1.9855e-15)*x2^3+(-1.5849e-15)*x2^4+(0.29414)*x2*h1+(-2.1514e-17)*x2*h1^2+(0.91119)*x2*h1^3+(3.3)*x2^2*h1+(-5.8409e-16)*x2^2*h1^2+(2.6389)*x2^3*h1+(-1.2501)*x2*x1+(-1.1131e-16)*x2*x1^2+(-1.3121)*x2*x1^3+(-3.3885)*x2^2*x1+(-1.709e-15)*x2^2*x1^2+(-2.7192)*x2^3*x1+(-2.4035e-17)*x2*x1*h1+(-0.91101)*x2*x1*h1^2+(1.1141)*x2*x1^2*h1+(1.2699e-15)*x2^2*x1*h1+(-5.3718e-16)*x2*h2+(6.5761e-16)*x2*h2^2+(5.9748e-16)*x2*h2^3+(-2.7065e-15)*x2^2*h2+(7.5093e-16)*x2^2*h2^2+(6.0429e-16)*x2^3*h2+(-0.0005013)*x2*h2*h1+(-1.8228e-16)*x2*h2*h1^2+(0.45095)*x2*h2^2*h1+(0.73702)*x2^2*h2*h1+(0.093606)*x2*h2*x1+(1.5428e-15)*x2*h2*x1^2+(-0.44983)*x2*h2^2*x1+(-0.65627)*x2^2*h2*x1+(5.1795e-18)*x2*h2*x1*h1+(0.025285)*h3+(2.2358e-17)*h3^2+(-0.0050622)*h3^3+(-1.0248e-18)*h3^4+(-3.1715e-16)*h3*h1+(-0.30584)*h3*h1^2+(-8.6466e-17)*h3*h1^3+(3.956)*h3^2*h1+(2.6418e-16)*h3^2*h1^2+(-4.8492e-16)*h3^3*h1+(2.1282e-16)*h3*x1+(-0.07096)*h3*x1^2+(1.4734e-15)*h3*x1^3+(-4.408)*h3^2*x1+(5.2877e-16)*h3^2*x1^2+(4.8495e-16)*h3^3*x1+(1.6977)*h3*x1*h1+(1.0183e-16)*h3*x1*h1^2+(-1.4205e-15)*h3*x1^2*h1+(-7.948e-16)*h3^2*x1*h1+(-5.1177)*h3*h2+(-0.15956)*h3*h2^2+(-0.046167)*h3*h2^3+(2.6224e-16)*h3^2*h2+(2.7662e-16)*h3^2*h2^2+(-32.023)*h3^3*h2+(-1.0647e-16)*h3*h2*h1+(-0.045332)*h3*h2*h1^2+(-8.8257e-17)*h3*h2^2*h1+(0.96315)*h3^2*h2*h1+(1.3872e-15)*h3*h2*x1+(-0.93262)*h3*h2*x1^2+(-4.3368e-17)*h3*h2^2*x1+(-0.86124)*h3^2*h2*x1+(0.034379)*h3*h2*x1*h1+(5.1305)*h3*x2+(-0.48159)*h3*x2^2+(0.90328)*h3*x2^3+(-2.643e-16)*h3^2*x2+(-1.7576e-15)*h3^2*x2^2+(32.024)*h3^3*x2+(1.4083e-16)*h3*x2*h1+(0.022198)*h3*x2*h1^2+(-1.1448e-16)*h3*x2^2*h1+(0.43615)*h3^2*x2*h1+(-1.3863e-15)*h3*x2*x1+(0.94597)*h3*x2*x1^2+(5.5955e-15)*h3*x2^2*x1+(-0.53871)*h3^2*x2*x1+(-0.024315)*h3*x2*x1*h1+(0.87698)*h3*x2*h2+(0.061195)*h3*x2*h2^2+(-0.91884)*h3*x2^2*h2+(1.4817e-15)*h3^2*x2*h2+(-5.0392e-16)*h3*x2*h2*h1+(-4.8912e-15)*h3*x2*h2*x1  ];
L_old=[L1;L2;L3];
% rem(sqrt(L_old(1)^2+L_old(2)^2),2*pi)*sign(L_old(1)*cos(state(3)))
L=[rem(sqrt(L_old(1)^2+L_old(2)^2)*sign(L_old(1)*cos(state(3))),2*pi);L_old(3)];
end



%%%%%%%%%%% partitioned change of variable trick

% K_gain=[  (44.808)+(-0.0037833)*h1+(5.8641)*h1^2+(-0.033216)*h1^3+(0.15911)*h2+(5.9542)*h2^2+(0.12054)*h2^3+(-0.10625)*h2*h1+(0.054131)*h2*h1^2+(-0.035623)*h2^2*h1+(0.007878)*h3+(5.5369)*h3^2+(-0.045405)*h3*h1+(0.00021099)*h3*h1^2+(-1.3208e-05)*h3^2*h1+(0.023934)*h3*h2+(0.0071593)*h3*h2^2+(-4.6157e-06)*h3^2*h2+(-0.010279)*h3*h2*h1  (0.068009)+(0.014989)*h1+(0.023398)*h1^2+(-0.0081352)*h1^3+(0.0011238)*h2+(0.013797)*h2^2+(0.0047523)*h2^3+(-0.0012558)*h2*h1+(0.00093571)*h2*h1^2+(-0.0043921)*h2^2*h1+(0.0022151)*h3+(0.01447)*h3^2+(0.0016843)*h3*h1+(-0.0055956)*h3*h1^2+(-1.2322e-05)*h3^2*h1+(-0.0045712)*h3*h2+(-0.00029703)*h3*h2^2+(-7.4758e-06)*h3^2*h2+(-0.0023054)*h3*h2*h1  (-13.654)+(0.0014032)*h1+(-3.1092)*h1^2+(0.0096151)*h1^3+(-0.052789)*h2+(-3.1363)*h2^2+(-0.034892)*h2^3+(0.031392)*h2*h1+(-0.015669)*h2*h1^2+(0.010312)*h2^2*h1+(-0.0024564)*h3+(-3.0113)*h3^2+(0.013401)*h3*h1+(-6.107e-05)*h3*h1^2+(3.8234e-06)*h3^2*h1+(-0.0069961)*h3*h2+(-0.0020724)*h3*h2^2+(1.3361e-06)*h3^2*h2+(0.0029755)*h3*h2*h1  ];
% K=K_gain*[h1;h2;h3];
% L1a=[  (-18.799)+(-3.4408)*x1+(-2.8277)*x1^2+(-0.12401)*x1^3+(1.0351)*x2+(-3.4287)*x2^2+(-2.766)*x2^3+(-0.17894)*x2*x1+(-1.1722)*x2*x1^2+(-0.015254)*x2^2*x1  ];
% L1b=[  (5.0297)+(1.3834)*x1+(0.28167)*x1^2+(0.049814)*x1^3+(-0.55084)*x2+(0.52698)*x2^2+(0.51459)*x2^3+(0.073216)*x2*x1+(0.1543)*x2*x1^2+(0.0071137)*x2^2*x1  ];
% L1c=[         (98.055)+(18.079)*x1+(12.868)*x1^2+(0.65402)*x1^3+(-6.2939)*x2+(15.657)*x2^2+(12.267)*x2^3+(0.94221)*x2*x1+(5.1026)*x2*x1^2+(0.083846)*x2^2*x1  ];
% L1=[L1a;L1b;L1c];
% L2a=[  (-18.799)+(1.4536e-09)*h1+(4.5179e-09)*h1^2+(8.9127e-10)*h1^3+(-3.4408)*x1+(-2.8277)*x1^2+(-0.12401)*x1^3+(4.6587e-07)*x1*h1+(-6.147e-08)*x1*h1^2+(5.3173e-10)*x1^2*h1+(5.8558e-09)*h2+(3.3059e-09)*h2^2+(1.8624e-09)*h2^3+(1.1629e-10)*h2*h1+(1.2706e-09)*h2*h1^2+(6.4554e-10)*h2^2*h1+(-3.6685e-07)*h2*x1+(-6.1133e-10)*h2*x1^2+(-2.8803e-07)*h2^2*x1+(2.0109e-07)*h2*x1*h1+(1.0351)*x2+(-3.4287)*x2^2+(-2.766)*x2^3+(1.0918e-09)*x2*h1+(-3.1356e-10)*x2*h1^2+(1.4464e-09)*x2^2*h1+(-0.17894)*x2*x1+(-1.1722)*x2*x1^2+(-0.015255)*x2^2*x1+(2.2911e-07)*x2*x1*h1+(-5.5117e-10)*x2*h2+(-4.1844e-10)*x2*h2^2+(-8.7189e-10)*x2^2*h2+(4.126e-10)*x2*h2*h1+(-1.5525e-07)*x2*h2*x1+(-3.6643e-08)*h3+(1.1231e-08)*h3^2+(8.4307e-13)*h3^3+(-1.0242e-08)*h3*h1+(2.5481e-09)*h3*h1^2+(-3.9879e-09)*h3^2*h1+(-4.0951e-06)*h3*x1+(3.2696e-09)*h3*x1^2+(-1.7012e-11)*h3^2*x1+(2.1407e-08)*h3*x1*h1+(1.5505e-08)*h3*h2+(2.0094e-08)*h3*h2^2+(-8.8404e-10)*h3^2*h2+(-1.2288e-08)*h3*h2*h1+(-3.0346e-08)*h3*h2*x1+(-8.5899e-09)*h3*x2+(2.2667e-09)*h3*x2^2+(1.8985e-12)*h3^2*x2+(8.1786e-10)*h3*x2*h1+(-1.2273e-10)*h3*x2*x1+(-1.9602e-09)*h3*x2*h2+(-7.968e-15)*x3                      (-18.799)+(3.1448e-08)*h1+(-3.3181e-09)*h1^2+(3.4924e-08)*h1^3+(-3.4408)*x1+(-2.8277)*x1^2+(-0.12401)*x1^3+(1.3096e-09)*x1*h1+(-1.728e-10)*x1*h1^2+(1.4949e-12)*x1^2*h1+(-1.9804e-08)*h2+(3.1444e-09)*h2^2+(-1.2234e-08)*h2^3+(4.3596e-09)*h2*h1+(-7.5588e-09)*h2*h1^2+(1.6054e-08)*h2^2*h1+(-1.0313e-09)*h2*x1+(-1.7185e-12)*h2*x1^2+(-8.097e-10)*h2^2*x1+(5.6529e-10)*h2*x1*h1+(1.0351)*x2+(-3.4287)*x2^2+(-2.766)*x2^3+(9.1223e-08)*x2*h1+(-9.4591e-09)*x2*h1^2+(8.862e-08)*x2^2*h1+(-0.17894)*x2*x1+(-1.1722)*x2*x1^2+(-0.015254)*x2^2*x1+(6.4407e-10)*x2*x1*h1+(-6.7375e-08)*x2*h2+(-4.4697e-08)*x2*h2^2+(-6.2557e-08)*x2^2*h2+(3.4488e-08)*x2*h2*h1+(-4.3642e-10)*x2*h2*x1+(0.5)*h3+(2.2762e-09)*h3^2+(3.1624e-13)*h3^3+(-1.7006e-09)*h3*h1+(3.637e-09)*h3*h1^2+(6.0008e-10)*h3^2*h1+(-1.1512e-08)*h3*x1+(9.1913e-12)*h3*x1^2+(-4.7822e-14)*h3^2*x1+(6.0177e-11)*h3*x1*h1+(5.3805e-09)*h3*h2+(4.9096e-09)*h3*h2^2+(-4.8846e-10)*h3^2*h2+(-1.9738e-09)*h3*h2*h1+(-8.5306e-11)*h3*h2*x1+(-6.9808e-07)*h3*x2+(5.385e-10)*h3*x2^2+(-6.25e-13)*h3^2*x2+(3.3949e-09)*h3*x2*h1+(-3.4506e-13)*h3*x2*x1+(-3.6161e-09)*h3*x2*h2+(0.5)*x3       (-1)+(-7.5921e-10)*h1+(-2.241e-09)*h1^2+(-3.9423e-10)*h1^3+(8.1361e-09)*x1+(4.6444e-09)*x1^2+(3.6266e-08)*x1^3+(-1.3486e-07)*x1*h1+(1.7794e-08)*x1*h1^2+(-2.266e-10)*x1^2*h1+(0.5)*h2+(-1.4311e-09)*h2^2+(-9.0889e-10)*h2^3+(-1.1343e-10)*h2*h1+(-6.2475e-10)*h2*h1^2+(-2.4319e-10)*h2^2*h1+(1.0619e-07)*h2*x1+(1.7429e-10)*h2*x1^2+(8.3377e-08)*h2^2*x1+(-5.8209e-08)*h2*x1*h1+(0.5)*x2+(-4.0724e-10)*x2^2+(-7.8528e-10)*x2^3+(-3.1611e-10)*x2*h1+(9.0771e-11)*x2*h1^2+(-5.3896e-10)*x2^2*h1+(-7.5438e-09)*x2*x1+(-1.3901e-10)*x2*x1^2+(1.5987e-08)*x2^2*x1+(-6.6846e-08)*x2*x1*h1+(1.5959e-10)*x2*h2+(1.2115e-10)*x2*h2^2+(2.439e-10)*x2^2*h2+(-1.1946e-10)*x2*h2*h1+(4.5229e-08)*x2*h2*x1+(1.1337e-08)*h3+(-3.2909e-09)*h3^2+(-2.4565e-13)*h3^3+(2.9843e-09)*h3*h1+(-6.2698e-10)*h3*h1^2+(1.1739e-09)*h3^2*h1+(1.1854e-06)*h3*x1+(-9.6342e-10)*h3*x1^2+(4.9244e-12)*h3^2*x1+(-6.1966e-09)*h3*x1*h1+(-4.6631e-09)*h3*h2+(-6.054e-09)*h3*h2^2+(2.3544e-10)*h3^2*h2+(3.6598e-09)*h3*h2*h1+(8.7841e-09)*h3*h2*x1+(2.487e-09)*h3*x2+(-6.9225e-10)*h3*x2^2+(-5.4955e-13)*h3^2*x2+(-2.3675e-10)*h3*x2*h1+(6.3319e-11)*h3*x2*x1+(5.6742e-10)*h3*x2*h2+(3.2835e-15)*x3  ];
% L2b=[        (5.0297)+(-5.4895e-10)*h1+(-1.7062e-09)*h1^2+(-3.3659e-10)*h1^3+(1.3834)*x1+(0.28167)*x1^2+(0.049815)*x1^3+(-1.7594e-07)*x1*h1+(2.3214e-08)*x1*h1^2+(-2.0081e-10)*x1^2*h1+(-2.6401e-09)*h2+(-1.5482e-09)*h2^2+(-9.7828e-10)*h2^3+(-4.3919e-11)*h2*h1+(-4.7986e-10)*h2*h1^2+(-2.4379e-10)*h2^2*h1+(2.1106e-07)*h2*x1+(3.1017e-10)*h2*x1^2+(1.7222e-07)*h2^2*x1+(-7.5942e-08)*h2*x1*h1+(-0.55084)*x2+(0.52698)*x2^2+(0.51459)*x2^3+(-4.1233e-10)*x2*h1+(1.1842e-10)*x2*h1^2+(-5.4625e-10)*x2^2*h1+(0.073216)*x2*x1+(0.1543)*x2*x1^2+(0.0071138)*x2^2*x1+(-8.6525e-08)*x2*x1*h1+(3.1191e-10)*x2*h2+(2.4719e-10)*x2*h2^2+(4.3476e-10)*x2^2*h2+(-1.5582e-10)*x2*h2*h1+(8.6494e-08)*x2*h2*x1+(-0.5)*h3+(-4.5655e-09)*h3^2+(-3.8922e-13)*h3^3+(3.8681e-09)*h3*h1+(-9.6231e-10)*h3*h1^2+(1.506e-09)*h3^2*h1+(1.6524e-06)*h3*x1+(-1.7065e-09)*h3*x1^2+(9.2922e-12)*h3^2*x1+(-8.0844e-09)*h3*x1*h1+(-9.1211e-09)*h3*h2+(-1.2112e-08)*h3*h2^2+(5.0503e-10)*h3^2*h2+(4.6406e-09)*h3*h2*h1+(1.2906e-08)*h3*h2*x1+(2.9603e-09)*h3*x2+(-1.0865e-09)*h3*x2^2+(-1.332e-12)*h3^2*x2+(-3.0887e-10)*h3*x2*h1+(2.9498e-10)*h3*x2*x1+(1.2713e-09)*h3*x2*h2+(-0.5)*x3  (5.0297)+(-1.1876e-08)*h1+(1.2531e-09)*h1^2+(-1.3189e-08)*h1^3+(1.3834)*x1+(0.28167)*x1^2+(0.049814)*x1^3+(-4.9459e-10)*x1*h1+(6.5259e-11)*x1*h1^2+(-5.6455e-13)*x1^2*h1+(1.0028e-08)*h2+(-2.2734e-09)*h2^2+(6.7798e-09)*h2^3+(-1.6464e-09)*h2*h1+(2.8546e-09)*h2*h1^2+(-6.0629e-09)*h2^2*h1+(5.9332e-10)*h2*x1+(8.7192e-13)*h2*x1^2+(4.8413e-10)*h2^2*x1+(-2.1348e-10)*h2*x1*h1+(-0.55084)*x2+(0.52698)*x2^2+(0.51459)*x2^3+(-3.4451e-08)*x2*h1+(3.5723e-09)*x2*h1^2+(-3.3468e-08)*x2^2*h1+(0.073216)*x2*x1+(0.1543)*x2*x1^2+(0.0071137)*x2^2*x1+(-2.4323e-10)*x2*x1*h1+(3.8039e-08)*x2*h2+(2.6984e-08)*x2*h2^2+(3.3493e-08)*x2^2*h2+(-1.3025e-08)*x2*h2*h1+(2.4315e-10)*x2*h2*x1+(6.3792e-09)*h3+(-9.6539e-10)*h3^2+(-1.536e-13)*h3^3+(6.4226e-10)*h3*h1+(-1.3735e-09)*h3*h1^2+(-2.2662e-10)*h3^2*h1+(4.6452e-09)*h3*x1+(-4.7971e-12)*h3*x1^2+(2.6122e-14)*h3^2*x1+(-2.2726e-11)*h3*x1*h1+(-2.2223e-09)*h3*h2+(-1.8977e-09)*h3*h2^2+(3.9146e-10)*h3^2*h2+(7.4542e-10)*h3*h2*h1+(3.6281e-11)*h3*h2*x1+(2.8158e-07)*h3*x2+(-1.7988e-10)*h3*x2^2+(3.2857e-13)*h3^2*x2+(-1.2821e-09)*h3*x2*h1+(8.2924e-13)*h3*x2*x1+(1.6285e-09)*h3*x2*h2+(-1.4745e-17)*x3  (5.5291e-09)+(-0.5)*h1+(8.4631e-10)*h1^2+(1.4888e-10)*h1^3+(-0.5)*x1+(-1.9768e-09)*x1^2+(-1.9989e-08)*x1^3+(5.0929e-08)*x1*h1+(-6.7198e-09)*x1*h1^2+(8.5576e-11)*x1^2*h1+(9.368e-10)*h2+(6.7376e-10)*h2^2+(4.8132e-10)*h2^3+(4.2836e-11)*h2*h1+(2.3594e-10)*h2*h1^2+(9.1842e-11)*h2^2*h1+(-6.1096e-08)*h2*x1+(-9.2237e-11)*h2*x1^2+(-4.9852e-08)*h2^2*x1+(2.1983e-08)*h2*x1*h1+(-6.8253e-10)*x2+(1.3914e-10)*x2^2+(3.0746e-10)*x2^3+(1.1938e-10)*x2*h1+(-3.428e-11)*x2*h1^2+(2.0354e-10)*x2^2*h1+(3.6695e-09)*x2*x1+(4.0347e-11)*x2*x1^2+(-8.0544e-09)*x2^2*x1+(2.5245e-08)*x2*x1*h1+(-9.0313e-11)*x2*h2+(-7.1573e-11)*x2*h2^2+(-1.219e-10)*x2^2*h2+(4.5114e-11)*x2*h2*h1+(-2.5207e-08)*x2*h2*x1+(-2.6239e-09)*h3+(1.3419e-09)*h3^2+(1.1312e-13)*h3^3+(-1.127e-09)*h3*h1+(2.3678e-10)*h3*h1^2+(-4.4335e-10)*h3^2*h1+(-4.7832e-07)*h3*x1+(5.1067e-10)*h3*x1^2+(-2.6898e-12)*h3^2*x1+(2.3402e-09)*h3*x1*h1+(2.7481e-09)*h3*h2+(3.6622e-09)*h3*h2^2+(-1.3507e-10)*h3^2*h2+(-1.3821e-09)*h3*h2*h1+(-3.736e-09)*h3*h2*x1+(-8.5709e-10)*h3*x2+(3.3515e-10)*h3*x2^2+(3.8556e-13)*h3^2*x2+(8.9409e-11)*h3*x2*h1+(-9.749e-11)*h3*x2*x1+(-3.6799e-10)*h3*x2*h2+(-6.6613e-16)*x3  ];
% L2c=[                                                 (148.43)+(-0.0075665)*h1+(11.728)*h1^2+(-0.066433)*h1^3+(18.079)*x1+(12.868)*x1^2+(0.65402)*x1^3+(-2.1872e-06)*x1*h1+(2.8859e-07)*x1*h1^2+(-2.4964e-09)*x1^2*h1+(0.31821)*h2+(11.908)*h2^2+(0.24107)*h2^3+(-0.21251)*h2*h1+(0.10826)*h2*h1^2+(-0.071246)*h2^2*h1+(1.7974e-06)*h2*x1+(2.9522e-09)*h2*x1^2+(1.4179e-06)*h2^2*x1+(-9.4409e-07)*h2*x1*h1+(-6.2939)*x2+(15.657)*x2^2+(12.267)*x2^3+(-5.126e-09)*x2*h1+(1.4721e-09)*x2*h1^2+(-6.7908e-09)*x2^2*h1+(0.94221)*x2*x1+(5.1026)*x2*x1^2+(0.083846)*x2^2*x1+(-1.0757e-06)*x2*x1*h1+(2.6951e-09)*x2*h2+(2.0568e-09)*x2*h2^2+(4.2026e-09)*x2^2*h2+(-1.9371e-09)*x2*h2*h1+(7.577e-07)*x2*h2*x1+(0.015756)*h3+(11.074)*h3^2+(-4.0314e-12)*h3^3+(-0.09081)*h3*h1+(0.00042196)*h3*h1^2+(-2.6398e-05)*h3^2*h1+(2.1528e-05)*h3*x1+(-1.5838e-08)*h3*x1^2+(8.2836e-11)*h3^2*x1+(-1.005e-07)*h3*x1*h1+(0.047869)*h3*h2+(0.014318)*h3*h2^2+(-9.227e-06)*h3^2*h2+(-0.020558)*h3*h2*h1+(1.4397e-07)*h3*h2*x1+(4.7205e-08)*h3*x2+(-1.0881e-08)*h3*x2^2+(-9.5496e-12)*h3^2*x2+(-3.8398e-09)*h3*x2*h1+(8.3349e-10)*h3*x2*x1+(9.7523e-09)*h3*x2*h2+(-1.4343e-16)*x3                                    (98.191)+(0.029978)*h1+(0.046796)*h1^2+(-0.016271)*h1^3+(18.079)*x1+(12.868)*x1^2+(0.65402)*x1^3+(-6.1485e-09)*x1*h1+(8.1127e-10)*x1*h1^2+(-7.0182e-12)*x1^2*h1+(0.0022476)*h2+(0.027593)*h2^2+(0.0095046)*h2^3+(-0.0025117)*h2*h1+(0.0018715)*h2*h1^2+(-0.0087843)*h2^2*h1+(5.0526e-09)*h2*x1+(8.2989e-12)*h2*x1^2+(3.986e-09)*h2^2*x1+(-2.654e-09)*h2*x1*h1+(-6.2939)*x2+(15.657)*x2^2+(12.267)*x2^3+(-4.2828e-07)*x2*h1+(4.4409e-08)*x2*h1^2+(-4.1606e-07)*x2^2*h1+(0.94221)*x2*x1+(5.1026)*x2*x1^2+(0.083846)*x2^2*x1+(-3.0238e-09)*x2*x1*h1+(3.2935e-07)*x2*h2+(2.203e-07)*x2*h2^2+(3.0391e-07)*x2^2*h2+(-1.6192e-07)*x2*h2*h1+(2.13e-09)*x2*h2*x1+(0.0044302)*h3+(0.02894)*h3^2+(-1.5201e-12)*h3^3+(0.0033687)*h3*h1+(-0.011191)*h3*h1^2+(-2.4646e-05)*h3^2*h1+(6.0519e-08)*h3*x1+(-4.4524e-11)*h3*x1^2+(2.3286e-13)*h3^2*x1+(-2.8253e-10)*h3*x1*h1+(-0.0091423)*h3*h2+(-0.00059409)*h3*h2^2+(-1.4949e-05)*h3^2*h2+(-0.0046107)*h3*h2*h1+(4.0471e-10)*h3*h2*x1+(3.6708e-06)*h3*x2+(-2.5039e-09)*h3*x2^2+(3.0301e-12)*h3^2*x2+(-1.5938e-08)*h3*x2*h1+(2.3433e-12)*h3*x2*x1+(1.7249e-08)*h3*x2*h2+(-8.7092e-15)*x3                   (-28.108)+(0.0028064)*h1+(-6.2185)*h1^2+(0.01923)*h1^3+(-3.9439e-08)*x1+(-2.4562e-08)*x1^2+(-1.8292e-07)*x1^3+(6.3313e-07)*x1*h1+(-8.3539e-08)*x1*h1^2+(1.0639e-09)*x1^2*h1+(-0.10558)*h2+(-6.2726)*h2^2+(-0.069783)*h2^3+(0.062784)*h2*h1+(-0.031338)*h2*h1^2+(0.020624)*h2^2*h1+(-5.2028e-07)*h2*x1+(-8.4562e-10)*h2*x1^2+(-4.1045e-07)*h2^2*x1+(2.7328e-07)*h2*x1*h1+(-8.1721e-09)*x2+(1.8628e-09)*x2^2+(4.1517e-09)*x2^3+(1.4841e-09)*x2*h1+(-4.2616e-10)*x2*h1^2+(2.5304e-09)*x2^2*h1+(3.9078e-08)*x2*x1+(9.6956e-10)*x2*x1^2+(-8.0973e-08)*x2^2*x1+(3.1383e-07)*x2*x1*h1+(-7.8036e-10)*x2*h2+(-5.9552e-10)*x2*h2^2+(-1.1759e-09)*x2^2*h2+(5.6084e-10)*x2*h2*h1+(-2.2076e-07)*x2*h2*x1+(-0.0049129)*h3+(-6.0227)*h3^2+(1.1744e-12)*h3^3+(0.026802)*h3*h1+(-0.00012214)*h3*h1^2+(7.6412e-06)*h3^2*h1+(-6.2317e-06)*h3*x1+(4.6751e-09)*h3*x1^2+(-2.3978e-11)*h3^2*x1+(2.9092e-08)*h3*x1*h1+(-0.013992)*h3*h2+(-0.0041447)*h3*h2^2+(2.671e-06)*h3^2*h2+(0.005951)*h3*h2*h1+(-4.1674e-08)*h3*h2*x1+(-1.3667e-08)*h3*x2+(3.3263e-09)*h3*x2^2+(2.7643e-12)*h3^2*x2+(1.1115e-09)*h3*x2*h1+(-3.7341e-10)*h3*x2*x1+(-2.823e-09)*h3*x2*h2+(4.1525e-17)*x3  ];
% L2=[L2a;L2b;L2c];





%%%%%%%%%%%%%%% all inv(P) trick from this line on, testing with transformation
function [K,L]=inhouseDOFread(state)
n=3;
x=msspoly('x',n);
h=msspoly('h',n);
load('DOFfeedback.mat')

s1=sin(state(1));
s2=cos(state(1));
s3=state(2);
sh1=sin(state(3));
sh2=cos(state(3));
sh3=state(4);

K=dmsubs(K',h,[sh1;sh2;sh3])'*[sh1;sh2;sh3];

L1=dmsubs(L(1,1),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L2=dmsubs(L(1,2),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L3=dmsubs(L(1,3),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L4=dmsubs(L(2,1),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L5=dmsubs(L(2,2),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L6=dmsubs(L(2,3),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L7=dmsubs(L(3,1),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L8=dmsubs(L(3,2),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L9=dmsubs(L(3,3),[h;x],[sh1;sh2;sh3;s1;s2;s3]);
L_old=[L1,L2,L3;L4,L5 L6;L7 L8 L9]*([s1;s2;s3]-[sh1;sh2;sh3]);
L=[sqrt(L_old(1)^2+L_old(2)^2)*sign(state(1)*L_old(1));L_old(3)];
end


function [K,L]=inhouseDOF(x)
  x1=sin(x(1));
  x2=cos(x(1));
  x3=x(2);
  h1=sin(x(3));
  h2=cos(x(3));
  h3=x(4);

% % doesn't allow lowest to have vdot=0
%  K_gain=  [  (21.044)+(-2.4208e-17)*h1+(8.8772)*h1^2+(-2.5601)*h2+(8.8815)*h2^2+(-3.0962e-16)*h2*h1+(-5.7616e-15)*h3+(3.6996)*h3^2+(-8.1667)*h3*h1+(5.8797e-16)*h3*h2  (5.8129e-17)+(-1.7099e-34)*h1+(6.2702e-17)*h1^2+(-1.9973e-17)*h2+(1.0151e-17)*h2^2+(-2.1869e-33)*h2*h1+(0.021455)*h3+(-2.0644e-16)*h3^2+(-5.7684e-17)*h3*h1+(-1.1134)*h3*h2  (-4.9877)+(5.0185e-18)*h1+(-1.8403)*h1^2+(0.53074)*h2+(-1.8412)*h2^2+(6.4186e-17)*h2*h1+(1.8914e-15)*h3+(-2.4796)*h3^2+(1.693)*h3*h1+(-1.2305e-16)*h3*h2  ];
% L1=[  (15.581)+(-5.6608e-15)*h1+(11.98)*h1^2+(2.0198e-15)*x1+(6.6255)*x1^2+(-7.8502)*x1*h1+(-0.07969)*h2+(7.2014)*h2^2+(-1.428e-15)*h2*h1+(1.8676e-15)*h2*x1+(0.044386)*x2+(10.591)*x2^2+(1.4244e-16)*x2*h1+(-2.7327e-15)*x2*x1+(2.7924)*x2*h2+(-3.2623e-15)*h3+(4.8039)*h3^2+(-0.2009)*h3*h1+(0.52607)*h3*x1+(-3.9138e-15)*h3*x2+(-4.1111e-15)*x3+(7.3583)*x3^2+(4.3108)*x3*h1+(-0.46311)*x3*x1+(-1.479e-15)*x3*h2+(-1.4534e-15)*x3*x2+(0.35644)*x3*h3  (-1.0186e-16)+(-0.005312)*h1+(1.4248e-16)*h1^2+(0.0053069)*x1+(-1.84e-16)*x1^2+(3.2774e-16)*x1*h1+(-8.4418e-16)*h2+(-3.7963e-17)*h2^2+(1.0951)*h2*h1+(0.4292)*h2*x1+(3.4411e-16)*x2+(3.0233e-16)*x2^2+(-1.2663)*x2*h1+(-0.095013)*x2*x1+(3.5101e-16)*x2*h2+(0.0057327)*h3+(-2.0923e-16)*h3^2+(3.7144e-17)*h3*h1+(-1.0554e-16)*h3*x1+(0.053968)*h3*x2+(-0.034603)*x3+(-2.4548e-16)*x3^2+(3.9551e-16)*x3*h1+(3.0334e-16)*x3*x1+(0.03924)*x3*h2+(-0.050761)*x3*x2+(1.4369e-17)*x3*h3  (-3.4177)+(1.1567e-15)*h1+(-2.4895)*h1^2+(-4.0009e-16)*x1+(-1.3492)*x1^2+(1.7968)*x1*h1+(0.035338)*h2+(-1.4971)*h2^2+(1.318e-16)*h2*h1+(-5.2666e-16)*h2*x1+(-0.017409)*x2+(-2.2421)*x2^2+(2.3972e-17)*x2*h1+(7.0533e-16)*x2*x1+(-0.55525)*x2*h2+(3.8816e-16)*h3+(-0.99433)*h3^2+(0.56436)*h3*h1+(-0.042783)*h3*x1+(1.2718e-15)*h3*x2+(1.1538e-15)*x3+(-1.5254)*x3^2+(-1.7562)*x3*h1+(-0.048597)*x3*x1+(1.6104e-16)*x3*h2+(-5.1591e-17)*x3*x2+(-0.075146)*x3*h3  ];
% L2=[                                                               (-2.4207e-15)+(0.010709)*x1+(6.3481e-16)*x1^2+(-2.5763e-15)*h2+(3.4392e-15)*h2^2+(-9.3878)*h2*x1+(2.5918e-15)*x2+(-4.7403e-15)*x2^2+(-1.1758)*x2*x1+(3.9013e-15)*x2*h2+(-0.043208)*h3+(-1.3016e-15)*h3^2+(-2.6092e-15)*h3*h1+(-2.1466e-15)*h3*x1+(-0.2672)*h3*h2+(0.36327)*h3*x2+(-0.38902)*x3+(1.1661e-15)*x3^2+(2.1171e-16)*x3*x1+(4.1279)*x3*h2+(1.0782)*x3*x2+(7.9332e-16)*x3*h3                                                                                                        (2.2149)+(-5.4353e-17)*x1+(1.6511)*x1^2+(0.001097)*h2+(1.8202)*h2^2+(-2.5259e-17)*h2*x1+(-0.0047384)*x2+(0.94378)*x2^2+(-9.4839e-16)*x2*x1+(-1.0628)*x2*h2+(-3.9864e-16)*h3+(0.74626)*h3^2+(-0.0022071)*h3*h1+(-0.044671)*h3*x1+(-1.1787e-16)*h3*h2+(4.1763e-17)*h3*x2+(-4.0782e-16)*x3+(1.123)*x3^2+(-0.21027)*x3*x1+(9.7111e-17)*x3*h2+(3.587e-16)*x3*x2+(0.076191)*x3*h3                                                                       (7.0788e-16)+(-0.012834)*x1+(-2.0683e-16)*x1^2+(5.3567e-16)*h2+(-9.3091e-16)*h2^2+(2.1089)*h2*x1+(-5.4028e-16)*x2+(1.0977e-15)*x2^2+(0.29549)*x2*x1+(-9.0503e-16)*x2*h2+(0.0032365)*h3+(-9.8257e-17)*h3^2+(8.3045e-16)*h3*h1+(1.1137e-15)*h3*x1+(0.56845)*h3*h2+(-0.011199)*h3*x2+(0.10393)*x3+(-2.4057e-16)*x3^2+(-2.4126e-16)*x3*x1+(-1.7109)*x3*h2+(-0.37733)*x3*x2+(2.4471e-16)*x3*h3  ];
% L3=[                                                                                                                                                                                                  (-0.30077)+(5.733e-15)*x1+(-0.77826)*x1^2+(-0.085296)*x2+(-0.96363)*x2^2+(-1.9077e-15)*x2*x1+(-1.488e-16)*h3+(-2.1157)*h3^2+(-5.5656)*h3*x1+(2.8817e-15)*h3*x2+(5.3421e-16)*x3+(-0.27044)*x3^2+(-0.44871)*x3*x1+(1.8016e-16)*x3*x2+(2.8811)*x3*h3                                                                                                                                                                                                                  (-1.009e-16)+(0.0015918)*x1+(-1.6494e-16)*x1^2+(-3.1578e-16)*x2+(1.2908e-15)*x2^2+(0.013452)*x2*x1+(-0.011333)*h3+(5.9595e-17)*h3^2+(3.6156e-16)*h3*x1+(-0.86215)*h3*x2+(-0.00024893)*x3+(3.32e-16)*x3^2+(-2.2692e-17)*x3*x1+(-0.078442)*x3*x2+(5.5992e-17)*x3*h3                                                                                                                                                                                                                   (0.59244)+(-1.6402e-15)*x1+(0.75083)*x1^2+(0.019388)*x2+(0.78896)*x2^2+(7.8255e-16)*x2*x1+(3.6816e-17)*h3+(1.4377)*h3^2+(1.148)*h3*x1+(-9.9061e-16)*h3*x2+(-1.231e-15)*x3+(0.056064)*x3^2+(0.081173)*x3*x1+(5.6994e-16)*x3*x2+(-2.1043)*x3*h3  ];


% % %%%%%%%%% allow lowest to have vdot=0
% % K_gain=  [  (21.044)+(2.1897e-16)*h1+(8.8777)*h1^2+(-2.56)*h2+(8.8821)*h2^2+(-6.3627e-15)*h2*h1+(-1.2089e-15)*h3+(3.7021)*h3^2+(-8.168)*h3*h1+(-1.5829e-15)*h3*h2  (5.9896e-16)+(1.0361e-32)*h1+(4.2007e-16)*h1^2+(-1.4758e-16)*h2+(-5.5685e-16)*h2^2+(-3.0106e-31)*h2*h1+(0.021479)*h3+(3.5877e-16)*h3^2+(-3.8649e-16)*h3*h1+(-1.1136)*h3*h2  (-4.9881)+(-4.5397e-17)*h1+(-1.8405)*h1^2+(0.53074)*h2+(-1.8414)*h2^2+(1.3191e-15)*h2*h1+(-3.7352e-16)*h3+(-2.4805)*h3^2+(1.6934)*h3*h1+(2.6271e-16)*h3*h2  ];
% % L1=[  (15.583)+(7.0738e-15)*h1+(11.982)*h1^2+(-5.9023e-15)*x1+(6.6275)*x1^2+(-7.8531)*x1*h1+(-0.079658)*h2+(7.2028)*h2^2+(2.8333e-15)*h2*h1+(-1.0025e-15)*h2*x1+(0.044197)*x2+(10.592)*x2^2+(1.0075e-15)*x2*h1+(-2.9046e-17)*x2*x1+(2.7917)*x2*h2+(-5.8187e-16)*h3+(4.8059)*h3^2+(-0.20172)*h3*h1+(0.52658)*h3*x1+(1.6953e-15)*h3*x2+(5.1555e-15)*x3+(7.3585)*x3^2+(4.3115)*x3*h1+(-0.46437)*x3*x1+(1.4347e-15)*x3*h2+(2.2999e-15)*x3*x2+(0.35633)*x3*h3  (9.5311e-16)+(-0.0052964)*h1+(6.2533e-16)*h1^2+(0.005291)*x1+(2.0046e-16)*x1^2+(-5.3166e-16)*x1*h1+(9.1206e-16)*h2+(1.3302e-16)*h2^2+(1.0954)*h2*h1+(0.42913)*h2*x1+(-1.159e-15)*x2+(1.0761e-15)*x2^2+(-1.2665)*x2*h1+(-0.094879)*x2*x1+(6.6884e-17)*x2*h2+(0.005724)*h3+(4.3031e-16)*h3^2+(7.7984e-17)*h3*h1+(5.4314e-16)*h3*x1+(0.054037)*h3*x2+(-0.034602)*x3+(7.9776e-16)*x3^2+(-1.4954e-16)*x3*h1+(-7.2324e-17)*x3*x1+(0.039234)*x3*h2+(-0.05073)*x3*x2+(-3.327e-17)*x3*h3  (-3.4183)+(-1.7758e-15)*h1+(-2.4901)*h1^2+(1.5301e-15)*x1+(-1.3498)*x1^2+(1.7976)*x1*h1+(0.03533)*h2+(-1.4975)*h2^2+(-6.4802e-16)*h2*h1+(5.1364e-16)*h2*x1+(-0.017366)*x2+(-2.2425)*x2^2+(-6.224e-16)*x2*h1+(-8.7525e-17)*x2*x1+(-0.55514)*x2*h2+(1.4433e-16)*h3+(-0.99486)*h3^2+(0.56463)*h3*h1+(-0.043006)*h3*x1+(-7.3045e-16)*h3*x2+(-9.2311e-16)*x3+(-1.5256)*x3^2+(-1.7564)*x3*h1+(-0.048334)*x3*x1+(-1.1571e-16)*x3*h2+(3.4324e-17)*x3*x2+(-0.075144)*x3*h3  ];
% % L2=[                                                                 (2.7114e-15)+(0.010771)*x1+(1.6489e-15)*x1^2+(1.6203e-15)*h2+(-3.6682e-16)*h2^2+(-9.3889)*h2*x1+(-1.5923e-15)*x2+(2.392e-15)*x2^2+(-1.1753)*x2*x1+(-3.5448e-15)*x2*h2+(-0.043101)*h3+(8.9756e-16)*h3^2+(-1.7419e-15)*h3*h1+(-2.1967e-15)*h3*x1+(-0.26761)*h3*h2+(0.36324)*h3*x2+(-0.38887)*x3+(2.1991e-16)*x3^2+(-2.648e-15)*x3*x1+(4.1288)*x3*h2+(1.0781)*x3*x2+(4.0373e-15)*x3*h3                                                                                                         (2.2151)+(4.2949e-16)*x1+(1.6513)*x1^2+(0.0011202)*h2+(1.8206)*h2^2+(-8.0541e-16)*h2*x1+(-0.0047759)*x2+(0.94412)*x2^2+(7.0086e-16)*x2*x1+(-1.0632)*x2*h2+(1.1337e-16)*h3+(0.74654)*h3^2+(-0.0022563)*h3*h1+(-0.044721)*h3*x1+(1.1506e-16)*h3*h2+(4.2728e-16)*h3*x2+(1.3293e-16)*x3+(1.1231)*x3^2+(-0.21042)*x3*x1+(1.0796e-15)*x3*h2+(4.7078e-16)*x3*x2+(0.07621)*x3*h3                                                                            (-3.1981e-16)+(-0.012849)*x1+(-9.6607e-17)*x1^2+(-3.4473e-16)*h2+(-2.5233e-16)*h2^2+(2.1093)*h2*x1+(3.4332e-16)*x2+(-2.6923e-16)*x2^2+(0.29541)*x2*x1+(8.243e-16)*x2*h2+(0.0032188)*h3+(-7.782e-16)*h3^2+(1.4821e-16)*h3*h1+(6.8177e-16)*h3*x1+(0.56867)*h3*h2+(-0.011231)*h3*x2+(0.10389)*x3+(2.0429e-17)*x3^2+(3.2474e-16)*x3*x1+(-1.7112)*x3*h2+(-0.37735)*x3*x2+(-9.9252e-16)*x3*h3  ];
% % L3=[                                                                                                                                                                                                 (-0.30132)+(1.6229e-15)*x1+(-0.77836)*x1^2+(-0.085081)*x2+(-0.96455)*x2^2+(-2.9974e-15)*x2*x1+(2.9459e-15)*h3+(-2.1168)*h3^2+(-5.5672)*h3*x1+(8.6811e-17)*h3*x2+(-2.3643e-15)*x3+(-0.27033)*x3^2+(-0.44856)*x3*x1+(8.6909e-15)*x3*x2+(2.8821)*x3*h3                                                                                                                                                                                                           (-2.9265e-16)+(0.0015962)*x1+(4.6211e-16)*x1^2+(2.4499e-16)*x2+(-8.3933e-16)*x2^2+(0.013449)*x2*x1+(-0.011316)*h3+(-3.8036e-16)*h3^2+(-1.3921e-16)*h3*x1+(-0.86244)*h3*x2+(-0.00024897)*x3+(-1.7557e-15)*x3^2+(3.9203e-16)*x3*x1+(-0.078431)*x3*x2+(-5.0921e-16)*x3*h3                                                                                                                                                                                                                      (0.5926)+(-8.3389e-16)*x1+(0.7509)*x1^2+(0.019337)*x2+(0.78932)*x2^2+(1.0452e-15)*x2*x1+(-7.5428e-16)*h3+(1.4383)*h3^2+(1.1484)*h3*x1+(-8.0216e-16)*h3*x2+(4.6177e-16)*x3+(0.056045)*x3^2+(0.08106)*x3*x1+(-2.7901e-15)*x3*x2+(-2.1045)*x3*h3  ];


%%%%%%% with transformation, and partial observabale state

K_gain=[  (23.236)+(9.5121e-17)*h1+(9.7749)*h1^2+(-2.8055)*h2+(9.7803)*h2^2+(1.3832e-15)*h2*h1+(2.8137e-15)*h3+(4.4799)*h3^2+(-7.213)*h3*h1+(3.5964e-16)*h3*h2  (-5.7931e-16)+(3.0185e-34)*h1+(3.1019e-17)*h1^2+(-1.6527e-17)*h2+(2.2458e-16)*h2^2+(4.3895e-33)*h2*h1+(0.024595)*h3+(-1.2287e-16)*h3^2+(-2.289e-17)*h3*h1+(-0.89184)*h3*h2  (-5.5718)+(-2.078e-17)*h1+(-2.1354)*h1^2+(0.61288)*h2+(-2.1366)*h2^2+(-3.0218e-16)*h2*h1+(-1.0023e-15)*h3+(-2.5159)*h3^2+(1.5757)*h3*h1+(-1.1988e-16)*h3*h2  ];
L1=[  (17.618)+(-8.9581e-16)*h1+(13.247)*h1^2+(-1.5265e-15)*x1+(7.2781)*x1^2+(-9.2393)*x1*h1+(-0.17362)*h2+(7.9717)*h2^2+(-4.0047e-16)*h2*h1+(3.5833e-18)*h2*x1+(0.058536)*x2+(11.329)*x2^2+(-3.658e-15)*x2*h1+(7.708e-15)*x2*x1+(2.9243)*x2*h2+(6.2703e-15)*h3+(4.9477)*h3^2+(-0.47622)*h3*h1+(0.49161)*h3*x1+(2.3516e-15)*h3*x2  (1.2619e-16)+(-0.010066)*h1+(-2.6105e-17)*h1^2+(0.010055)*x1+(5.4808e-16)*x1^2+(-5.5256e-16)*x1*h1+(-3.0386e-16)*h2+(2.1709e-16)*h2^2+(1.0928)*h2*h1+(0.4159)*h2*x1+(3.0263e-16)*x2+(-2.267e-16)*x2^2+(-1.2383)*x2*h1+(-0.09152)*x2*x1+(2.1389e-17)*x2*h2+(0.0093773)*h3+(4.5661e-17)*h3^2+(2.8952e-16)*h3*h1+(3.7194e-16)*h3*x1+(0.05432)*h3*x2  (-4.091)+(3.0913e-16)*h1+(-2.956)*h1^2+(2.1747e-16)*x1+(-1.5634)*x1^2+(2.2963)*x1*h1+(0.062222)*h2+(-1.7741)*h2^2+(2.1152e-16)*h2*h1+(3.8035e-17)*h2*x1+(-0.022495)*x2+(-2.5022)*x2^2+(7.2005e-16)*x2*h1+(-1.6919e-15)*x2*x1+(-0.59675)*x2*h2+(-1.8129e-15)*h3+(-1.0616)*h3^2+(0.61961)*h3*h1+(-0.050584)*h3*x1+(-8.0876e-16)*h3*x2  ];
L2=[                                                (-1.502e-15)+(0.078583)*x1+(-8.7536e-16)*x1^2+(-2.9311e-16)*h2+(3.3588e-15)*h2^2+(-10.641)*h2*x1+(2.8847e-16)*x2+(1.3949e-15)*x2^2+(-1.3746)*x2*x1+(-3.146e-15)*x2*h2+(-0.066345)*h3+(3.6668e-15)*h3^2+(1.1559e-15)*h3*h1+(1.6617e-16)*h3*x1+(-0.41181)*h3*h2+(0.41076)*h3*x2                                                                               (2.2098)+(-3.4487e-16)*x1+(1.6414)*x1^2+(0.0026203)*h2+(1.79)*h2^2+(-5.8102e-16)*h2*x1+(-0.0076145)*x2+(0.91692)*x2^2+(6.9648e-16)*x2*x1+(-1.0374)*x2*h2+(4.0575e-16)*h3+(0.70851)*h3^2+(-0.0068384)*h3*h1+(-0.052731)*h3*x1+(-4.893e-16)*h3*h2+(-2.4705e-17)*h3*x2                                                     (6.2102e-16)+(-0.031738)*x1+(5.5824e-19)*x1^2+(2.286e-16)*h2+(-1.0307e-15)*h2^2+(2.5467)*h2*x1+(-2.3193e-16)*x2+(-8.2472e-17)*x2^2+(0.33788)*x2*x1+(6.4651e-16)*x2*h2+(0.010425)*h3+(-1.0966e-15)*h3^2+(-4.0568e-16)*h3*h1+(-5.4051e-16)*h3*x1+(0.57667)*h3*h2+(-0.048785)*h3*x2  ];
L3=[                                                                                                                                                              (-0.58269)+(-2.9422e-15)*x1+(-0.85189)*x1^2+(-0.13246)*x2+(-0.94611)*x2^2+(-9.1811e-17)*x2*x1+(-7.0472e-15)*h3+(-3.9802)*h3^2+(-5.673)*h3*x1+(2.4388e-15)*h3*x2                                                                                                                                                                           (6.1111e-16)+(0.0034596)*x1+(4.1635e-16)*x1^2+(-1.3327e-15)*x2+(3.4455e-16)*x2^2+(0.017732)*x2*x1+(-0.012673)*h3+(5.4009e-16)*h3^2+(-4.1487e-16)*h3*x1+(-0.82104)*h3*x2                                                                                                                                                                             (0.5973)+(9.6693e-16)*x1+(0.67191)*x1^2+(0.03403)*x2+(0.67124)*x2^2+(-3.3628e-16)*x2*x1+(1.9941e-15)*h3+(2.4068)*h3^2+(1.2261)*h3*x1+(-1.6152e-15)*h3*x2  ];

K=K_gain*[h1;h2;h3];

L_old=[L1;L2;L3]*([x1;x2;x3]-[h1;h2;h3]);
L=[sqrt(L_old(1)^2+L_old(2)^2)*sign(x(1)*L_old(1));L_old(3)];
end



%%%%% inv(P) trick, without transformation but works

% function [K,L]=inhouseDOF(x)
%   x1=sin(x(1));
%   x2=cos(x(1));
%   x3=x(2);
%   h1=sin(x(3));
%   h2=cos(x(3));
%   h3=x(4);
%   K_gain=[(34.342)+(8.374e-17)*h1+(13.925)*h1^2+(-3.7776)*h2+(13.928)*h2^2+(-9.9501e-16)*h2*h1+(-1.6675e-15)*h3+(8.663)*h3^2+(-16.298)*h3*h1+(2.2257e-17)*h3*h2  (-1.9165e-16)+(3.496e-34)*h1+(5.8135e-17)*h1^2+(-3.0719e-17)*h2+(-5.5451e-17)*h2^2+(-4.154e-33)*h2*h1+(0.021676)*h3+(-4.892e-17)*h3^2+(-6.8042e-17)*h3*h1+(-1.5833)*h3*h2  (-8.692)+(-1.987e-17)*h1+(-3.3042)*h1^2+(0.89636)*h2+(-3.3048)*h2^2+(2.361e-16)*h2*h1+(-2.3267e-16)*h3+(-3.7413)*h3^2+(3.8673)*h3*h1+(-5.1733e-17)*h3*h2];
%   K=K_gain*[h1;h2;h3];
%   L1=[(32.203)+(1.5893e-14)*h1+(25.823)*h1^2+(-1.5811e-14)*x1+(14.178)*x1^2+(-16.742)*x1*h1+(-0.081822)*h2+(15.754)*h2^2+(1.09e-14)*h2*h1+(-1.0939e-14)*h2*x1+(0.074)*x2+(22.764)*x2^2+(1.4887e-14)*x2*h1+(-1.3132e-14)*x2*x1+(5.8928)*x2*h2+(2.2462e-14)*h3+(10.606)*h3^2+(-1.5743)*h3*h1+(0.65941)*h3*x1+(2.3178e-14)*h3*x2+(3.1796e-14)*x3+(15.202)*x3^2+(7.5765)*x3*h1+(-0.37034)*x3*x1+(7.4817e-15)*x3*h2+(-7.3831e-16)*x3*x2+(0.85529)*x3*h3  (-5.9152e-16)+(-0.003727)*h1+(-3.8348e-17)*h1^2+(0.0037245)*x1+(1.1361e-16)*x1^2+(7.4978e-16)*x1*h1+(5.8707e-16)*h2+(3.9871e-17)*h2^2+(1.5962)*h2*h1+(0.59724)*h2*x1+(-1.1707e-15)*x2+(-1.0271e-15)*x2^2+(-1.8662)*x2*h1+(-0.16199)*x2*x1+(2.4431e-16)*x2*h2+(0.0054976)*h3+(5.4666e-16)*h3^2+(-1.8037e-15)*h3*h1+(2.2193e-15)*h3*x1+(0.065105)*h3*x2+(-0.030339)*x3+(1.2878e-15)*x3^2+(4.0758e-16)*x3*h1+(-6.4122e-17)*x3*x1+(0.040833)*x3*h2+(-0.032956)*x3*x2+(-2.8814e-16)*x3*h3  (-7.7656)+(-4.0442e-15)*h1+(-6.1276)*h1^2+(4.0246e-15)*x1+(-3.3495)*x1^2+(4.0829)*x1*h1+(0.030004)*h2+(-3.7395)*h2^2+(-3.0252e-15)*h2*h1+(3.2885e-15)*h2*x1+(-0.0232)*x2+(-5.4268)*x2^2+(-3.0499e-15)*x2*h1+(2.7602e-15)*x2*x1+(-1.3792)*x2*h2+(-5.7239e-15)*h3+(-2.5114)*h3^2+(0.90064)*h3*h1+(-0.082894)*h3*x1+(-5.8356e-15)*h3*x2+(-7.4642e-15)*x3+(-3.6072)*x3^2+(-2.5924)*x3*h1+(-0.041321)*x3*x1+(-1.8684e-15)*x3*h2+(7.665e-16)*x3*x2+(-0.20332)*x3*h3  ];
%   L2=[                                                             (-4.63e-15)+(0.0014236)*x1+(-7.6418e-16)*x1^2+(5.1232e-16)*h2+(-4.2296e-15)*h2^2+(-19.806)*h2*x1+(-5.1625e-16)*x2+(1.2857e-14)*x2^2+(-2.1379)*x2*x1+(-3.7788e-15)*x2*h2+(0.017809)*h3+(8.4872e-15)*h3^2+(-1.8151e-14)*h3*h1+(1.7712e-14)*h3*x1+(-1.6502)*h3*h2+(0.32533)*h3*x2+(-0.40985)*x3+(4.255e-15)*x3^2+(-5.8251e-15)*x3*x1+(7.2884)*x3*h2+(1.5161)*x3*x2+(-6.5533e-15)*x3*h3                                                                                                                   (3.1458)+(5.8638e-16)*x1+(2.3677)*x1^2+(0.0014335)*h2+(2.6765)*h2^2+(6.1207e-16)*h2*x1+(-0.0020127)*x2+(1.3861)*x2^2+(5.4842e-16)*x2*x1+(-1.611)*x2*h2+(9.7297e-16)*h3+(1.1055)*h3^2+(-0.0041881)*h3*h1+(-0.040004)*h3*x1+(-1.8311e-15)*h3*h2+(3.8879e-15)*h3*x2+(1.416e-15)*x3+(1.5678)*x3^2+(-0.2024)*x3*x1+(8.602e-16)*x3*h2+(-1.8252e-15)*x3*x2+(0.10207)*x3*h3                                                                        (9.8681e-16)+(-0.0052785)*x1+(7.6233e-17)*x1^2+(-2.1901e-16)*h2+(1.1831e-15)*h2^2+(4.8024)*h2*x1+(2.2589e-16)*x2+(-4.253e-15)*x2^2+(0.53656)*x2*x1+(2.1907e-15)*x2*h2+(-0.012496)*h3+(-2.4905e-15)*h3^2+(4.3284e-15)*h3*h1+(-4.7869e-15)*h3*x1+(0.91467)*h3*h2+(-0.0085444)*h3*x2+(0.10711)*x3+(-9.6363e-16)*x3^2+(1.8102e-15)*x3*x1+(-2.5142)*x3*h2+(-0.48066)*x3*x2+(1.432e-15)*x3*h3  ];
%   L3=[                                                                                                                                                                                                (-1.9349)+(-7.6005e-15)*x1+(-2.5701)*x1^2+(-0.03386)*x2+(-2.7478)*x2^2+(5.5474e-15)*x2*x1+(1.1289e-15)*h3+(-5.2577)*h3^2+(-12.336)*h3*x1+(-2.3571e-14)*h3*x2+(6.4898e-15)*x3+(-0.33393)*x3^2+(-1.0803)*x3*x1+(5.3517e-15)*x3*x2+(7.2684)*x3*h3                                                                                                                                                                                                                   (-5.8945e-16)+(0.0038354)*x1+(1.4369e-15)*x1^2+(-1.4224e-15)*x2+(-5.8644e-15)*x2^2+(0.020248)*x2*x1+(-0.015426)*h3+(-5.7115e-15)*h3^2+(-1.2139e-15)*h3*x1+(-1.2635)*h3*x2+(-0.00013539)*x3+(7.9639e-17)*x3^2+(6.9994e-16)*x3*x1+(-0.12648)*x3*x2+(9.5811e-16)*x3*h3                                                                                                                                                                                                                    (0.95014)+(1.6476e-15)*x1+(1.2059)*x1^2+(0.0066892)*x2+(1.2356)*x2^2+(-1.0533e-15)*x2*x1+(7.6591e-17)*h3+(2.259)*h3^2+(2.9226)*h3*x1+(8.117e-15)*h3*x2+(-1.2381e-15)*x3+(0.079236)*x3^2+(0.25404)*x3*x1+(-1.8263e-15)*x3*x2+(-3.2023)*x3*h3  ];
%   L_old=[L1;L2;L3]*([x1;x2;x3]-[h1;h2;h3]);
%   L=[sqrt(L_old(1)^2+L_old(2)^2)*sign(x(1)-x(3));L_old(3)];
% end

% %%%%%% six states version

    % function xdot = dynamicsRHS(~,~,x,u)
    %   % x = [s; c; thetadot];
    %   p = MyPendulum;
    %   % actualx=x(1:3);
    %   % hatx=x(4:6);
    %   fx = [x(2)*x(3); -x(1)*x(3); (-p.b*x(3) - p.m*p.g*p.l*x(1))/(p.m*p.l^2)];
    %   fxhat=[x(5)*x(6); -x(4)*x(6); (-p.b*x(6) - p.m*p.g*p.l*x(4))/(p.m*p.l^2)];
    %   [K,L]=testingDOF(x);
    %   xdot=[fx+K;fxhat+K];
    %   % xdot=[fx+K;fxhat-L];
    %   % fx = [x(2,:).*x(3,:); -x(1,:).*x(3,:); (-p.b.*x(3,:) - p.m*p.g*p.l.*x(1,:)-3)/(p.m*p.l.^2)];
    %   % fxhat=[x(5,:).*x(6,:); -x(4,:).*x(6,:); (-p.b.*x(6,:) - p.m*p.g*p.l.*x(4,:)-3)/(p.m*p.l.^2)];
    %   % df = [zeros(3,1),[0, x(3)/2, x(2)/2;-x(3)/2, 0, -x(1)/2; -p.g/p.l, 0, -p.b/(p.m*p.l.^2)]];
    % end   
    % function y=output(~,~,x,~)
    %   y(1)=atan2(x(1),x(2));
    %   y(2)=x(3);
    % end
